import os
import sys
import time
import ttkbootstrap as ttk
from ttkbootstrap.constants import *
from tkinter import filedialog, messagebox
import batch_process
import matplotlib.pyplot as plt
from vtk_viewer import open_vtk_viewer
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from stl_processing import load_stl, save_stl, split_model
from section_analysis import compute_long_axis, find_max_section, plot_heatmap_on_section

class STLProcessingApp:
    def __init__(self, root):
        self.root = root
        self.root.title("STL File Processing Tool")
        self.root.geometry("1080x800")
        self.root.resizable(True, True)

        self.root.protocol("WM_DELETE_WINDOW", self.on_close)

        self.mode = "single"
        self.selected_file = None
        self.selected_folder = None
        self.stl_save_directory_single = None
        self.stl_save_directory_batch = None
        self.heatmap_save_directory_single = None
        self.heatmap_save_directory_batch = None

        self.vtk_widget = None
        self.create_widgets()

    def switch_mode(self):
        if self.mode == "single":
            self.mode = "batch"
            messagebox.showinfo("模式切换", "已切换到【批量处理模式】")
        else:
            self.mode = "single"
            messagebox.showinfo("模式切换", "已切换到【单独处理模式】")

        self.update_buttons()

    def update_buttons(self):
        for widget in self.control_frame.winfo_children():
            widget.destroy()

        self.switch_var = ttk.BooleanVar(value=0 if self.mode == "single" else 1)
        self.switch_btn = ttk.Checkbutton(
            self.control_frame, text="批量处理",
            variable=self.switch_var, command=self.switch_mode,
            style="success.TCheckbutton",
            bootstyle=TOGGLE
        )
        self.switch_btn.pack(pady=10, fill=ttk.X, padx=10)

        # 添加标注
        self.label_default_mode = ttk.Label(
            self.control_frame, text="系统默认单一处理",
            style="secondary.TLabel"
        )
        self.label_default_mode.pack(pady=5, fill=ttk.X, padx=10)

        if self.mode == "single":
            self.btn_select_file = ttk.Button(self.control_frame, text="请选择文件处理", command=self.select_stl_file, style="primary.TButton")
            self.btn_select_file.pack(pady=10, fill=ttk.X, padx=10)
        else:
            self.btn_batch_process = ttk.Button(self.control_frame, text="请选择文件夹批量处理", command=self.batch_process, style="primary.TButton")
            self.btn_batch_process.pack(pady=10, fill=ttk.X, padx=10)

        self.btn_select_stl_save = ttk.Button(self.control_frame, text="选择STL文件存储位置", command=self.select_stl_save_directory, style="secondary.TButton")
        self.btn_select_stl_save.pack(pady=10, fill=ttk.X, padx=10)

        self.btn_select_heatmap_save = ttk.Button(self.control_frame, text="选择热力图生成位置", command=self.select_heatmap_save_directory, style="secondary.TButton")
        self.btn_select_heatmap_save.pack(pady=10, fill=ttk.X, padx=10)

        self.btn_process_file = ttk.Button(self.control_frame, text="处理文件", command=self.process_file, style="success.TButton")
        self.btn_process_file.pack(pady=10, fill=ttk.X, padx=10)

        self.btn_open_heatmap = ttk.Button(self.control_frame, text="打开投影图", command=self.open_heatmap, style="warning.TButton")
        self.btn_open_heatmap.pack(pady=10, fill=ttk.X, padx=10)

        self.btn_view_stl = ttk.Button(self.control_frame, text="STL文件三维展示", command=self.select_and_view_stl, style="info.TButton")
        self.btn_view_stl.pack(pady=10, fill=ttk.X, padx=10)

    def create_widgets(self):
        self.canvas_frame = ttk.Frame(self.root, width=800, height=800)
        self.canvas_frame.pack(side=ttk.LEFT, fill=ttk.BOTH, expand=True)

        self.control_frame = ttk.Frame(self.root, width=280, bootstyle="light")
        self.control_frame.pack(side=ttk.RIGHT, fill=ttk.Y)

        self.update_buttons()

    def select_and_view_stl(self):
        self.selected_view_file = filedialog.askopenfilename(filetypes=[("STL Files", "*.stl")])
        if self.selected_view_file:
            open_vtk_viewer(self.selected_view_file)

    def select_stl_file(self):
        self.selected_file = filedialog.askopenfilename(filetypes=[("STL Files", "*.stl")])
        if self.selected_file:
            messagebox.showinfo("文件已选择", f"已选择文件: {self.selected_file}")

    def select_stl_save_directory(self):
        folder = filedialog.askdirectory()
        if folder:
            if self.mode == "single":
                self.stl_save_directory_single = folder
                messagebox.showinfo("保存路径", f"单独处理的 STL 存储路径: {folder}")
            else:
                self.stl_save_directory_batch = folder
                messagebox.showinfo("保存路径", f"批量处理的 STL 存储路径: {folder}")

    def select_heatmap_save_directory(self):
        folder = filedialog.askdirectory()
        if folder:
            if self.mode == "single":
                self.heatmap_save_directory_single = folder
                messagebox.showinfo("保存路径", f"单独处理的热力图存储路径: {folder}")
            else:
                self.heatmap_save_directory_batch = folder
                messagebox.showinfo("保存路径", f"批量处理的热力图存储路径: {folder}")

    def open_heatmap(self):
        heatmap_file = filedialog.askopenfilename(filetypes=[("PNG Files", "*.png")])
        if not heatmap_file:
            messagebox.showwarning("警告", "请先选择投影图文件！")
            return

        try:
            for widget in self.canvas_frame.winfo_children():
                widget.destroy()

            fig, ax = plt.subplots(figsize=(6, 6))
            img = plt.imread(heatmap_file)
            ax.imshow(img)
            ax.axis('off')

            canvas = FigureCanvasTkAgg(fig, master=self.canvas_frame)
            canvas.draw()
            canvas.get_tk_widget().pack(fill=ttk.BOTH, expand=True)
        except Exception as e:
            messagebox.showerror("错误", f"无法打开投影图: {str(e)}")

    def process_file(self):
        if self.mode == "single":
            if not self.selected_file:
                messagebox.showwarning("警告", "请先选择 STL 文件！")
                return
            if not self.stl_save_directory_single or not self.heatmap_save_directory_single:
                messagebox.showwarning("警告", "请先选择 STL 和 热力图的存储位置！")
                return

            progress_window = ttk.Toplevel(self.root)
            progress_window.title("处理进度")
            progress_window.geometry("400x150")

            progress_label = ttk.Label(progress_window, text="正在处理，请稍候...")
            progress_label.pack(pady=10)

            progress_bar = ttk.Progressbar(progress_window, orient="horizontal", length=300, mode="determinate")
            progress_bar.pack(pady=10, fill=ttk.X, padx=20)

            progress_bar["value"] = 0
            self.root.update_idletasks()

            for progress in range(1, 100, 2):
                time.sleep(0.5)
                progress_bar["value"] = progress
                progress_label.config(text=f"进度: {progress}%")
                self.root.update_idletasks()

            batch_process.process_single_stl(self.selected_file, self.stl_save_directory_single, self.heatmap_save_directory_single)

            progress_bar["value"] = 100
            progress_label.config(text="处理完成！")
            self.root.update_idletasks()

            messagebox.showinfo("完成", "单个文件处理完成！")
            progress_window.destroy()

        else:
            if not self.selected_folder:
                messagebox.showwarning("警告", "请先选择批量处理的文件夹！")
                return
            if not self.stl_save_directory_batch or not self.heatmap_save_directory_batch:
                messagebox.showwarning("警告", "请先选择 STL 和 热力图的存储位置！")
                return

            stl_files = [f for f in os.listdir(self.selected_folder) if f.endswith(".stl")]
            total_files = len(stl_files)
            if total_files == 0:
                messagebox.showwarning("警告", "未找到 STL 文件！")
                return

            progress_window = ttk.Toplevel(self.root)
            progress_window.title("处理进度")
            progress_window.geometry("400x150")

            progress_label = ttk.Label(progress_window, text="正在批量处理，请稍候...")
            progress_label.pack(pady=10)

            progress_bar = ttk.Progressbar(progress_window, orient="horizontal", length=300, mode="determinate")
            progress_bar.pack(pady=10, fill=ttk.X, padx=20)

            progress_bar["value"] = 0
            self.root.update_idletasks()

            for idx, file_name in enumerate(stl_files):
                file_path = os.path.join(self.selected_folder, file_name)

                batch_process.process_single_stl(file_path, self.stl_save_directory_batch, self.heatmap_save_directory_batch)

                for progress in range(int((idx / total_files) * 100), int(((idx + 1) / total_files) * 100), 20):
                    time.sleep(0.3)
                    progress_bar["value"] = progress
                    progress_label.config(text=f"进度: {progress}%")
                    self.root.update_idletasks()

            progress_bar["value"] = 100
            progress_label.config(text="处理完成！")
            self.root.update_idletasks()

            messagebox.showinfo("完成", "批量处理已完成！")
            progress_window.destroy()

    def batch_process(self):
        folder = filedialog.askdirectory(title="选择包含 STL 文件的文件夹")
        if folder:
            self.selected_folder = folder
            messagebox.showinfo("文件夹已选择", f"批量处理目标文件夹: {folder}")

    def on_close(self):
        self.root.destroy()
        os._exit(0)

if __name__ == "__main__":
    root = ttk.Window(themename="litera")
    app = STLProcessingApp(root)
    root.mainloop()
