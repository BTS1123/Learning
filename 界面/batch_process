import os
import time
from stl_processing import load_stl, save_stl, split_model
from section_analysis import compute_long_axis, find_max_section, plot_heatmap_on_section

def process_single_stl(file_path, output_stl_folder, output_heatmap_folder):
    """å¤„ç†å•ä¸ª STL æ–‡ä»¶"""
    file_name_prefix = os.path.splitext(os.path.basename(file_path))[0]

    try:
        # **1. åŠ è½½ STL æ–‡ä»¶**
        model = load_stl(file_path)

        # **2. è®¡ç®—ç‰™é½¿ä¸­å¿ƒå’Œä¸»è½´**
        center, long_axis = compute_long_axis(model)

        # **3. è®¡ç®—æœ€å¤§æˆªé¢**
        max_section_points, max_plane_point = find_max_section(model, center, long_axis)

        if max_plane_point is None:
            print(f"âš ï¸ æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„æœ€å¤§æˆªé¢ï¼Œè·³è¿‡: {file_path}")
            return

        # **4. åˆ‡å‰²æ¨¡å‹**
        upper, below = split_model(model, max_plane_point, long_axis)

        # **5. ä¿å­˜ STL æ–‡ä»¶**
        upper_stl_path = os.path.join(output_stl_folder, f"{file_name_prefix}_upper.stl")
        below_stl_path = os.path.join(output_stl_folder, f"{file_name_prefix}_below.stl")
        save_stl(upper, upper_stl_path)
        save_stl(below, below_stl_path)

        # **6. ç”Ÿæˆå¹¶ä¿å­˜çƒ­åŠ›å›¾**
        plot_heatmap_on_section(upper.reshape(-1, 3), max_plane_point, long_axis, output_heatmap_folder, f"{file_name_prefix}_upper")
        plot_heatmap_on_section(below.reshape(-1, 3), max_plane_point, long_axis, output_heatmap_folder, f"{file_name_prefix}_below")

        print(f"âœ… å•ä¸ª STL å¤„ç†å®Œæˆ: {file_path}")
    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥: {file_path}, é”™è¯¯: {str(e)}")

def batch_process_stl(input_folder, output_stl_folder, output_heatmap_folder):
    """æ‰¹é‡å¤„ç† STL æ–‡ä»¶"""
    if not os.path.exists(input_folder):
        print("âŒ è¾“å…¥æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è·¯å¾„")
        return

    os.makedirs(output_stl_folder, exist_ok=True)
    os.makedirs(output_heatmap_folder, exist_ok=True)

    stl_files = [f for f in os.listdir(input_folder) if f.endswith(".stl")]
    if not stl_files:
        print("âš ï¸ è¾“å…¥æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰ STL æ–‡ä»¶")
        return

    print(f"ğŸ”„ å¼€å§‹å¤„ç† {len(stl_files)} ä¸ª STL æ–‡ä»¶...")
    start_time = time.time()

    for file_name in stl_files:
        file_path = os.path.join(input_folder, file_name)
        process_single_stl(file_path, output_stl_folder, output_heatmap_folder)

    end_time = time.time()
    print(f"ğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")
